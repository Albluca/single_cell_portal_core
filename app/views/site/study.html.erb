<h1>Study: <%= @study.name %></h1>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "Overview <span class='fa fa-chevron-down'></span>".html_safe, '#overview', 'data-toggle' => 'collapse', class: 'white'  %></h4>
		</div>
	</div>
	<div id="overview" class="panel-collapse collapse in">
		<div class="panel-body">
			<%= @study.description.html_safe %>
		</div>
	</div>
</div>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "Downloads <span class='fa fa-chevron-right'></span>".html_safe, '#files', 'data-toggle' => 'collapse', class: 'white'  %></h4>
		</div>
	</div>
	<div id="files" class="panel-collapse collapse">
		<div class="panel-body">
			<div class="table-responsive">
				<table class="table table-striped table-condensed">
					<thead>
					<tr>
						<th>Filename</th>
						<th>Description</th>
						<th>Download</th>
					</tr>
					</thead>
					<tbody>
					<% @study.study_files.sort_by(&:name).each do |study_file| %>
						<tr>
							<td class="col-md-5"><%= study_file.name %></td>
							<td class="col-sm-6"><%= study_file.description %></td>
							<td class="col-sm-1"><%= link_to "<span class='fa fa-download'></span> #{number_to_human_size(study_file.file_size, prefix: :si)}".html_safe, study_file.download_path, class: 'btn btn-primary btn-block', download: study_file.name %></td>
						</tr>
					<% end %>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-sm-12">
		<%= render partial: 'study_cluster_nav' %>
		<%= render partial: 'gene_search_form' %>
		<%= render partial: 'study_precomputed_expression_nav' %>
	</div>
	<div class="col-md-3">
		<%= render partial: 'cluster_info' %>
	</div>
	<div class="col-md-9">
		<div id="cluster-plot"></div>
	</div>
</div>

<%= javascript_tag do %>

	<% @coordinates.sort_by {|k,v| k}.each_with_index do |(cluster, data), index| %>
		var <%= cluster %> = {
			x: <%= raw data[:x] %>,
			y: <%= raw data[:y] %>,
			text: <%= raw data[:text] %>,
			name: "<%= data[:name] %>",
			mode: 'markers',
			type: 'scatter',
			marker: { color: plotlyDefaultColors[<%= index %>] }
		};
	<% end %>

	var data = [];
	<% @clusters.each do |cluster| %>
		data.push(<%= cluster.name %>);
	<% end %>

	// use partial for layouts to avoid code duplication
	<%= render 'study_scatter_layout' %>

	Plotly.newPlot('cluster-plot', data, layout);

	$( window ).on('resizeEnd', function() {
		<%= render 'study_scatter_layout' %>

		Plotly.newPlot('cluster-plot', data, layout);
	});

<% end %>