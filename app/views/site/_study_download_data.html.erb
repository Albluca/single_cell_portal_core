<div class="row">
  <div class="col-xs-12">
    <h2>Study Files <span class="badge"><%= @study_files.count %></span>  <%= link_to "<i class='fa fa-question-circle'></i> Download Help".html_safe, 'javascript:;', class: 'btn btn-default pull-right', id: 'download-help' %></h2>
    <div class="modal fade" id="primary-data-download-modal" role="dialog" aria-labelledby="primary-data-download-modal" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-center">Download Help</h2>
          </div>
          <div class="modal-body">
            <p class="lead">To download any individual file, click the download button in the corresponding row.</p>
            <% if @study.can_direct_download?(current_user) %>
            <p class="lead">To download all files using <code>gsutil</code>, run the following command:</p>
            <pre>gsutil -m cp -r gs://<%= @study.bucket_id %> [target path]</pre>
              <% if @directories.any? %>
                <p class="lead">To download all data files in a specific folder, use the following commands:</p>
                <table class="table table-condensed table-striped">
                  <thead>
                  <tr>
                    <th>Folder</th>
                    <th>gsutil command</th>
                  </tr>
                  <% @directories.each do |directory| %>
                      <tr>
                        <td><%= directory.name %></td>
                        <td><pre>gsutil -m cp gs://<%= @study.bucket_id %><%= directory.download_display_name %>*.<%= directory.file_type %>*<%= %> [target path]</pre></td>
                      </tr>
                  <% end %>
                  </thead>
                </table>
              <% end %>
            <% elsif @study.public? %>
                <p class="lead">To download all files using <code>curl</code>, click the button below to get the download command:</p>
                <p class="lead"><%= link_to "<i class='fa fa-download'></i> Get download command for all study data".html_safe, 'javascript:;', class: 'btn btn-default get-download-command', id: 'get-download-command_all' %></p>
                <% if @directories.any? %>
                    <p class="lead">To download all data files in a specific folder, use the following commands:</p>
                    <table class="table table-condensed table-striped">
                      <thead>
                      <tr>
                        <th>Folder</th>
                        <th>curl command</th>
                      </tr>
                      <% @directories.each do |directory| %>
                          <tr>
                            <td><%= directory.name %></td>
                            <td>
                              <%= link_to "<i class='fa fa-download'></i> Get download command".html_safe, 'javascript:;', class: 'btn btn-default get-download-command', id: "get-download-command_#{directory.name}" %>
                            </td>
                          </tr>
                      <% end %>
                    </thead>
                    </table>
                <% end %>
            <% end %>
          </div>
          <div class="modal-footer">
            <button class="close" data-dismiss="modal">Ã—</button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
        $('#download-help').click(function() {
            $('#primary-data-download-modal').modal('show');
        });

        // Enables copying to clipboard upon clicking a "clipboard" icon,
        // like on GitHub.  https://clipboardjs.com.
        var clipboard = new Clipboard('.btn-copy');
        clipboard.on('success', function(event) {
          $('#' + event.trigger.id)
            .attr('title', 'Copied!')
            .tooltip('fixTitle')
            .tooltip('show');
        });

        // Show the download command upon clicking the "Get download command" button
        $('body').on('click', '.get-download-command', function(event) {

          var downloadButton = $(this);

          // 'all' or a particular directory listing, e.g. 'csvs'
          var directoryObject = downloadButton.attr('id').split('_')[1];

          // Get a time-based one time authentication token (totat),
          // then show the download command
          $.ajax({
            url: '/single_cell/totat',
            type: 'post'
          }).success(function(response) {
            var totat = response.totat;

            // Gets a curl configuration ("cfg.txt") containing signed
            // URLs and output names for all files in the download object.
            var url = (
              window.location.origin +
              '/single_cell/bulk_data' +
              '/<%= @study.url_safe_name %>' +
              '/' + directoryObject +
              '/' + totat
            );

            // For convenience when developing
            var flag = (window.location.host === 'localhost') ? '--insecure ' : '';

            // This is what the user will run in their terminal to download the data.
            var downloadCommand = (
              'curl ' + flag + '&quot;' + url + '&quot; -so /tmp/cfg.txt; ' +
              'curl -K /tmp/cfg.txt'
            );

            var commandID = 'command-' + totat;

            // TODO: Tighten the UX on this.
            downloadButton.parent().prepend(
              '<div class="input-group">' +
                '<input id="' + commandID + '" class="form-control" value="' + downloadCommand + '" readonly/>' +
                '<span class="input-group-btn">' +
                  '<button id="copy-button-' + totat + '" class="btn btn-default btn-copy" data-clipboard-target="#' + commandID + '" data-toggle="tooltip" title="Copy to clipboard">' +
                    '<img src="/single_cell/assets/clippy.svg" width="16px" alt="Copy to clipboard">' +
                  '</button>' +
                '</span>' +
              '</div>'
            );
            downloadButton.addClass('pull-right');
          });
        });
    </script>
  </div>
</div>
<div class="table-responsive">
  <table class="table table-striped table-condensed">
    <thead>
    <tr>
      <th class="col-sm-5">Filename</th>
      <th class="col-sm-6">Description</th>
      <th class="col-sm-1">Download</th>
    </tr>
    </thead>
    <tbody>
    <% @study_files.each do |study_file| %>
      <tr>
        <td><%= study_file.upload_file_name.nil? ? study_file.name : study_file.upload_file_name %> <%= study_file.file_type == 'Cluster' ? "<strong>(#{study_file.name})</strong>".html_safe : nil %></td>
        <td><%= study_file.description %></td>
        <td>
          <% if @allow_downloads %>
            <%= render partial: '/layouts/download_link', locals: {study: @study, study_file: study_file} %>
          <% else %>
            <%= button_to 'Currently Unavailable', 'javascript:;', class: 'btn btn-danger disabled-download', disabled: true %>
          <% end %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
  <% if @primary_study_files.any? || @primary_data.any? %>
    <div class="well well-sm">
      <h2>Primary Data <span class="badge"><%= @study.primary_data_file_count %></span> </h2>
      <table class="table table-striped tabled-condensed study-data-table" id="fastq-table">
        <thead>
        <tr>
          <th class="col-sm-5">Filename</th>
          <th class="col-sm-6">Description</th>
          <th class="col-sm-1">Download</th>
        </tr>
        </thead>
        <tbody id="fastq-files-target">
          <% @primary_study_files.each do |file| %>
            <tr>
              <td><%= file.name %></td>
              <td><%= file.description %></td>
              <td>
                <% if @allow_downloads %>
                  <%= render partial: '/layouts/download_link', locals: {study: @study, study_file: file} %>
                <% else %>
                  <%= button_to 'Currently Unavailable', 'javascript:;', class: 'btn btn-danger disabled-download', disabled: true %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% @primary_data.each do |directory| %>
            <% directory.files.each do |file| %>
              <% basename = file[:name].split('/').last %>
              <tr>
                <td><%= basename %></td>
                <td><%= directory.description %></td>
                <td><%= link_to("<span class='fa fa-download'></span> #{number_to_human_size(file[:size], prefix: :si)}".html_safe, directory.download_path(file[:name]), class: "btn btn-primary dl-link fastq", download: basename) %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
  <% if @other_data.any? %>
    <div class="well well-sm">
      <h2>Other Data <span class="badge"><%= @study.misc_directory_file_count %></span> </h2>
      <table class="table table-striped tabled-condensed study-data-table" id="other-data-table">
        <thead>
        <tr>
          <th class="col-sm-3">Filename</th>
          <th class="col-sm-2">Type</th>
          <th class="col-sm-5">Description</th>
          <th class="col-sm-1">Download</th>
        </tr>
        </thead>
        <tbody>
        <% @other_data.each do |directory| %>
          <% directory.files.each do |file| %>
            <% basename = file[:name].split('/').last %>
            <tr>
              <td><%= basename %></td>
              <td><%= directory.file_type %></td>
              <td><%= directory.description %></td>
              <td><%= link_to("<span class='fa fa-download'></span> #{number_to_human_size(file[:size], prefix: :si)}".html_safe, directory.download_path(file[:name]), class: "btn btn-primary dl-link fastq", download: basename) %></td>
            </tr>
          <% end %>
        <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>

<script type="text/javascript">


    $('#fastq-table').dataTable({
        pagingType: 'full',
        order: [[0, 'asc']],
        autoWidth: false
    });

    $('#other-data-table').dataTable({
        pagingType: 'full',
        order: [[1, 'asc'],[0, 'asc']],
        autoWidth: false
    });

</script>